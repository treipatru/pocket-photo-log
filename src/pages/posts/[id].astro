---
import { AstroSeo } from "@astrolib/seo";
import { format } from "date-fns";
import { getImgUrl } from "@/lib/get-img-url";
import { pocketClient } from "@/services/pocket/pocket-client";
import Hero from "@/components/hero.astro";
import PostComplete from "@/components/posts/post/post-complete";
import PostLayout from "@/layouts/post-layout.astro";

const { siteSettings } = Astro.locals;

const post = await pocketClient
	.collection("posts")
	.getFirstListItem(`id="${Astro.params.id}"`, {
		expand: "tags",
	});

const postDate = format(post.shot_on, "PPP");
const pageTitle = `${postDate} | ${siteSettings.TITLE}`;

try {
	await pocketClient.collection("posts").update(post.id, {
		views: post.views + 1,
	});
} catch (error) {
	console.error("Error updating post views", error);
}
---

<AstroSeo
	title={pageTitle}
	description={siteSettings.DESCRIPTION}
	openGraph={{
		url: Astro.url.host + Astro.url.pathname,
		title: pageTitle,
		description: siteSettings.DESCRIPTION,
		images: [{ url: getImgUrl(post, "medium") }],
		site_name: siteSettings.TITLE,
	}}
/>

<PostLayout>
	<Hero slot="hero" subtitle={`on ${postDate}`} />

	<PostComplete post={post} client:load />
</PostLayout>
