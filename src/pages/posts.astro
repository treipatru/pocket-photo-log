---
import { AstroSeo } from "@astrolib/seo";
import { pocketClient } from "@/services/pocket/pocket-client";
import BlogLayout from "@/layouts/blog-layout.astro";
import Hero from "@/components/hero.astro";
import Pagination from "@/components/ui/pagination.astro";
import PostTimeline from "@/components/posts/post-timeline/post-timeline";

const { siteSettings } = Astro.locals;

const page = parseInt(Astro.url.searchParams.get("page") || "1");
const activeYear = Astro.url.searchParams.get("year") ?? undefined;

const posts = await pocketClient.collection("posts").getList(page, 20, {
	sort: "-shot_on",
	expand: "tags",
	...(activeYear
		? {
				filter: `shot_on >= "${activeYear}-01-01 00:00:00" && shot_on <= "${activeYear}-12-31 23:59:59"`,
			}
		: {}),
});

const { items, ...pagination } = posts;
---

<AstroSeo
	title={`Posts page ${pagination.page} | ${siteSettings.TITLE}`}
	description={siteSettings.DESCRIPTION}
/>

<BlogLayout>
	<Hero slot="hero" subtitle={year ? `in ${year}` : undefined} />

	<PostTimeline activeYear={activeYear} posts={posts.items} />

	<Pagination {...pagination} url="/posts" itemsPerPage={20} />
</BlogLayout>
